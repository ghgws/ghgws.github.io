---
title: 拆解HTTP协议(1)
date: 2021-11-21 16:27:40
tags: "计算机网络", "HTTP"
---

这是拆解HTTP协议系列的第一篇文章。很多朋友认为网络协议的学习比较琐碎枯燥，我觉得计网的学习不该计较于某个细节，毕竟计网有那么多的协议，穷究于细节之中，既无必要也不现实。计网不论多么复杂，都是在描述两台计算机如何互相通信，所有协议的机制、细节的设计，必然也是为了解决相应的通信存在的问题。从这个角度来思考HTTP协议，就是本系列文章的主旨所在。一家之言，如有谬误，烦请斧正。

本系列文章计划写三篇：
- HTTP协议的基本运作
- HTTP协议面临的挑战
- HTTP协议体系

现在暂时先抛开HTTP协议（超文本传输协议）的现有实现，设想一下如果要自己设计一个应用层协议来实现数据通信，最需要明确的几个问题是什么？我想有以下几个：
- 通信的参与者
- 通信的内容

类比两个人通信，对一次通信过程，必然有人询问，另一个回答。在计算机通信中，二者就分别称为**客户端**和**服务器**。客户端发起的通信称为**请求**，服务器发起的通信称为**响应**。接下来是通信内容的问题，这个又可以拆解为两个问题：即资源解析问题和资源定位问题。
资源解析问题，可以类比一下文件扩展名，通知操作系统如何处理文件；资源定位问题，可以类比Id，同样是某个体在全体中的唯一标识。为了解决这两个问题，HTTP协议才采用了**MIME**和**URI**的概念。

MIME定义了一系列数据类型，例如text/html、text/plain、image/jpeg等等，通过这样的约定，来保证客户端和服务器都能正确的解析传输的数据或文件。

怎么为资源提供独一无二的标识（URI）呢？同样可以类比一下现实生活中找人的两种方式：
- 小范围内往往可以直接以姓名区分，范围扩大可能重名，这时就需要学号、工号乃至身份证号了。优点也很鲜明：稳定。但实现更困难一些，这对应于所谓的URN，仍然处于实验阶段。
- 快递邮寄地址，就好像人为划分的各级行政区和街道楼层一样，网络上的资源也可以根据所在位置逐级划分为scheme（协议）、host（主机）、path（路径）、name（资源名）、query（参数）、frag（片段）。这种方式实现更加简单直观，但是稳定性就不足了（好比搬家后原地址失效）。这对应的就是URL了。


解决了实现通信的两个基础问题，现在可以开始通信了。其实流程上与人之间交流很相似，但是计算机和人脑不同，通信必须按照一定的规则进行，否则就是“胡言乱语”，无法被理解。

那么通信的规则是什么呢？答案是报文。报文又可以分为请求报文和响应报文，两种的区别不大，结构都可以大致分为：
- 起始行：请求报文的起始行（请求行）说明希望服务器做些什么，响应报文的起始行（响应行）说明服务器实际做了什么。
- 首部：以键值对的形式对请求和响应补充信息。
- 通信实体：HTTP传输的载荷。

下面分别介绍。

##### 1.请求行
三部分构成：请求方法 URL HTTP版本。

###### 方法
告知服务器要做的事情的性质。
- GET：获取文档
- HEAD：获取文档的首部
- POST：向服务器发送数据（最常见的表单提交）
- PUT：要求服务器存储通信实体的内容
- DELETE：要求服务器删除某文档
- OPTIONS：询问服务器支持的方法
- TRACE：对可能经过代理服务器传送到服务器上的报文进行追踪

###### HTTP版本
客户端和服务器通过此来约定可以使用的HTTP特性和报文格式。

##### 2.响应行
同样三部分：HTTP版本 状态码 原因短语
###### 状态码
用来告诉客户端发生了什么。
- 200-299：成功
- 300-399：资源已经移动
- 400-499：客户端请求出错
- 500-599：服务器出错

其中最常见的有：
- 200：成功
- 304：资源未被修改
- 400：通用的客户端请求出错
- 403：请求被拒绝
- 404：找不到请求的URL
- 500：通用的服务器出错
- 503：服务暂不可用

###### 原因短语
对状态码的人类语言解释，便于理解

##### 3.首部

可以分为通用首部、请求首部、响应首部、实体首部和扩展首部五类。

###### 通用首部
在请求报文和响应报文中都有意义，提供了最基本的报文信息。
- 信息首部：如Date表示报文创建的时间；Via表示报文经过的代理服、网关等中间节点
- 缓存首部：如Cache-Control

###### 请求首部
只在请求报文中有意义。通常说明谁在发送请求、客户端的喜好和能力。
- 信息首部：如Host给出接收请求的服务器的主机名和端口号；User-Agent给出请求的客户端程序等
- Accept首部：客户端提供喜好和能力，使服务器响应更明智
- 条件请求首部：为请求加上条件限制
- 安全请求首部：在获取资源前提供认证机制，如Cookie
- 代理请求首部

###### 响应首部
为客户端提供额外信息。如响应者、响应者的功能等来优化客户端处理响应和发起请求。
- 信息首部：如Retry-After表示资源不可用可在此时间重试
- 协商首部
- 安全响应首部：如和Cookie相对应的Set-Cookie

###### 实体首部
- 内容首部：描述实体内容的类型、大小等信息，如Content-Type表示实体的MIME类型；Content-Length表示实体内容的长度
- 缓存首部：与被缓存实体相关的信息。如Expires表示缓存过期时间；Last-Modified表示资源上次被修改的时间